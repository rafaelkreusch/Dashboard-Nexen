<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nexen.ai  Fontes de Dados</title>
    <link rel="stylesheet" href="/app/styles.css?v=2" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 text-slate-800">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside class="w-72 bg-slate-900 text-slate-100 flex flex-col">
        <div class="p-5 flex items-center gap-3 border-b border-slate-800">
          <div class="rounded-lg">
            <img src="/app/Nexen.ai.png" alt="Logo" class="w-8 h-8 object-contain rounded" />
          </div>
          <div>
            <div class="text-lg font-semibold">Nexen.ai</div>
            <div class="text-xs text-slate-400">Analytics Platform</div>
          </div>
        </div>
        <nav class="p-3 flex-1">
          
<ul class="space-y-1 text-sm">
  <li><a class="nav-item" href="/app/index2.html"><img src="/app/dashboardlogo.png" alt="" class="nav-icon" />Dashboard</a></li>
  <li><a class="nav-item active" href="/app/datasources-fixed.html"><img src="/app/fontededados.png" alt="" class="nav-icon" />Fontes de Dados</a></li>
  <li><a class="nav-item" href="/app/datasets-fixed.html"><img src="/app/conjuntodedados.png" alt="" class="nav-icon" />Conjuntos de Dados</a></li>
  <li><a class="nav-item" href="/app/indicators-fixed.html"><img src="/app/indicadores.png" alt="" class="nav-icon" />Indicadores</a></li>
</ul>
<div class="mt-6 text-xs uppercase tracking-wide text-slate-400">Configuracao</div>
<ul class="mt-2 space-y-1 text-sm">
  <li><a class="nav-item" href="/app/org.html"><img src="/app/organizacao.png" alt="" class="nav-icon" />Organizacao</a></li>
  <li><a class="nav-item" href="#"><img src="/app/configuracao.png" alt="" class="nav-icon" />Configuracoes</a></li>
</ul>

        </nav>
        <div class="p-4 text-xs text-slate-400">v0.1.0</div>
      </aside>

      <!-- Content -->
      <main class="flex-1">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6">
          <div class="text-3xl font-extrabold">Fontes de Dados</div>
          <div class="flex items-center gap-3">
            <button id="btnAdd" class="btn-primary flex items-center gap-2">
              <span>+</span>
              <span>Adicionar Fonte de Dados</span>
            </button>
            <a id="btnLogin" href="/app/login.html" class="btn hidden">Entrar</a>
            <button id="btnLogout" class="btn hidden">Sair</button>
          </div>
        </header>

        <section class="p-6">
          <p class="text-slate-600">Conecte suas fontes de dados para começar a montar dashboards</p>
          <div class="mt-6 border border-slate-200 rounded-xl bg-white p-12 text-center" id="emptyState">
            <div class="grid place-items-center">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 text-slate-400">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75c0-.621.504-1.125 1.125-1.125h14.25c.621 0 1.125.504 1.125 1.125v10.5c0 .621-.504 1.125-1.125 1.125H4.875A1.125 1.125 0 013.75 17.25V6.75z" />
              </svg>
              <div class="mt-4 text-2xl font-semibold">Nenhuma fonte de dados ainda</n></div>
              <div class="mt-2 text-slate-500">Conecte sua primeira fonte de dados para começar a analisar. Suportamos upload de CSV, bancos de dados e APIs.</div>
              <button class="btn-primary mt-6" id="btnAdd2">+ Adicionar sua primeira fonte</button>
            </div>
          </div>

          <div id="listContainer" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="dsList"></div>
          </div>
        </section>
      </main>
    </div>

    <!-- Modal choose type / forms -->
    <div id="modal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div class="font-semibold">Escolha o Tipo de Fonte</div>
          <button id="btnClose" class="btn">×</button>
        </div>
        <div class="modal-body">
          <div id="step1" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="ds-tile" data-type="csv_upload">
              <div class="rounded bg-green-100 text-green-600 p-2">CSV</div>
              <div>
                <div class="font-semibold">Upload CSV / Excel</div>
                <div class="text-sm text-slate-500">Upload CSV ou XLSX</div>
              </div>
            </div>
            <div class="ds-tile" data-type="google_sheets">
              <div class="rounded bg-orange-100 text-orange-600 p-2">GS</div>
              <div>
                <div class="font-semibold">Google Sheets</div>
                <div class="text-sm text-slate-500">Conectar via OAuth</div>
              </div>
            </div>
            <div class="ds-tile" data-type="sql" data-driver="postgresql+psycopg2">
              <div class="rounded bg-blue-100 text-blue-600 p-2">PG</div>
              <div>
                <div class="font-semibold">PostgreSQL</div>
                <div class="text-sm text-slate-500">Conectar ao Postgres</div>
              </div>
            </div>
            <div class="ds-tile" data-type="sql" data-driver="mysql+pymysql">
              <div class="rounded bg-emerald-100 text-emerald-600 p-2">MY</div>
              <div>
                <div class="font-semibold">MySQL</div>
                <div class="text-sm text-slate-500">Conectar ao MySQL</div>
              </div>
            </div>
          </div>

          <form id="formSql" class="hidden space-y-3">
            <div class="text-sm text-slate-600">Informe a URL SQLAlchemy</div>
            <input id="sqlUrl" class="w-full border rounded p-2" placeholder="postgresql+psycopg2://user:pass@host:5432/db" />
            <div class="flex gap-2">
              <button id="btnTest" class="btn" type="button">Testar conexão</button>
              <button id="btnSaveSql" class="btn-primary" type="submit">Salvar</button>
              <button id="btnBack1" class="btn" type="button">Back</button>
            </div>
            <div id="sqlMsg" class="text-sm"></div>
          </form>

          <form id="formSheets" class="hidden space-y-3">
            <div class="text-sm text-slate-600">Informe o Spreadsheet ID e Range</div>
            <input id="sId" class="w-full border rounded p-2" placeholder="spreadsheet_id" />
            <input id="sRange" class="w-full border rounded p-2" placeholder="Aba ou intervalo (ex: Plan1)" />
            <label class="flex items-center gap-2 text-sm"><input id="sRecurring" type="checkbox"/> Recorrente (1h)</label>
            <div class="flex gap-2">
              <button id="btnSaveSheets" class="btn-primary" type="submit">Salvar</button>
              <button id="btnBack2" class="btn" type="button">Back</button>
            </div>
            <div class="text-sm text-slate-500">Dica: coloque credentials.json e autorize o gspread na primeira chamada.</div>
          </form>

          <form id="formCsv" class="hidden space-y-3">
            <div class="text-sm text-slate-600">Envie um CSV ou XLSX para ingestão imediata</div>
            <input id="csvFile" type="file" accept=".csv,.xlsx" class="w-full" />
            <div class="flex gap-2">
              <button id="btnUploadCsv" class="btn-primary" type="submit">Enviar</button>
              <button id="btnBack3" class="btn" type="button">Back</button>
            </div>
            <div id="csvMsg" class="text-sm"></div>
          </form>
        </div>
      </div>
    </div>

    <script src="/app/theme.js"></script>
    <script>
      Theme.init();
      const api = (p) => `${location.origin}${p}`;
      function token(){ return localStorage.getItem('token') || '' }
      function setToken(t){ localStorage.setItem('token', t) }
      function showAuthButtons(){ const has=!!token(); document.getElementById('btnLogin').classList.toggle('hidden', has); document.getElementById('btnLogout').classList.toggle('hidden', !has); }
      async function ensureToken(){
        if(token()) return true;
        try {
          const body = { email: 'dev@example.com', org_slug: 'demo', name: 'Dev User' };
          const r = await fetch(api('/auth/dev-login'), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
          if(!r.ok) return false;
          const j = await r.json(); setToken(j.access_token); return true;
        } catch { return false }
      }

      // Modal helpers
      const modal = document.getElementById('modal');
      const step1 = document.getElementById('step1');
      const formSql = document.getElementById('formSql');
      const formSheets = document.getElementById('formSheets');
      const formCsv = document.getElementById('formCsv');
      let selectedType = null; let selectedDriver = null;

      function openModal(){ modal.style.display='flex'; step1.classList.remove('hidden'); formSql.classList.add('hidden'); formSheets.classList.add('hidden'); formCsv.classList.add('hidden'); }
      function closeModal(){ modal.style.display='none'; }
      function showSql(){ step1.classList.add('hidden'); formSql.classList.remove('hidden'); }
      function showSheets(){ step1.classList.add('hidden'); formSheets.classList.remove('hidden'); }
      function showCsv(){ step1.classList.add('hidden'); formCsv.classList.remove('hidden'); }

      // Load list
      async function loadList(){
        if(!token()){ const ok = await ensureToken(); if(!ok){ document.getElementById('emptyState').classList.remove('hidden'); return } }
        const r = await fetch(api('/datasources'), { headers: { Authorization: `Bearer ${token()}` } })
        if(!r.ok){ return }
        const list = await r.json();
        const empty = list.length === 0;
        document.getElementById('emptyState').classList.toggle('hidden', !empty);
        document.getElementById('listContainer').classList.toggle('hidden', empty);
        if(!empty){
          const c = document.getElementById('dsList'); c.innerHTML='';
          list.forEach(ds => {
            const el = document.createElement('div');
            el.className = 'card';
            el.innerHTML = `<div class="text-xs text-slate-500">${ds.type}</div><div class="font-semibold">${ds.sqlalchemy_url || ''}</div><div class="text-xs text-slate-400 mt-1">recorrente: ${ds.is_recurring? 'sim':'não'}</div>`;
            c.appendChild(el);
          });
        }
      }

      // Handlers
      document.getElementById('btnAdd').onclick = openModal;
      document.getElementById('btnAdd2').onclick = openModal;
      document.getElementById('btnClose').onclick = closeModal;
      document.getElementById('btnBack1').onclick = () => { step1.classList.remove('hidden'); formSql.classList.add('hidden'); }
      document.getElementById('btnBack2').onclick = () => { step1.classList.remove('hidden'); formSheets.classList.add('hidden'); }
      document.getElementById('btnBack3').onclick = () => { step1.classList.remove('hidden'); formCsv.classList.add('hidden'); }

      step1.querySelectorAll('.ds-tile').forEach(div => {
        div.addEventListener('click', () => {
          selectedType = div.dataset.type; selectedDriver = div.dataset.driver || null;
          if(selectedType==='sql') showSql();
          else if(selectedType==='google_sheets') showSheets();
          else if(selectedType==='csv_upload') showCsv();
        });
      });

      // Dev login shortcut
      document.getElementById('btnLogout').addEventListener('click', () => { localStorage.removeItem('token'); showAuthButtons(); location.href = '/app/login.html?next=/app/datasources.html'; });

      // SQL form
      document.getElementById('btnTest').addEventListener('click', async () => {
        const url = document.getElementById('sqlUrl').value.trim();
        if(!url) return;
        const r = await fetch(api('/datasources/test'), { method:'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sqlalchemy_url: url })});
        const msg = document.getElementById('sqlMsg');
        msg.textContent = r.ok ? 'Conexão OK' : 'Falha ao conectar';
        msg.className = r.ok ? 'text-sm text-emerald-600' : 'text-sm text-rose-600';
      });
      document.getElementById('formSql').addEventListener('submit', async (e) => {
        e.preventDefault();
        const okTok = await ensureToken(); if(!okTok){ alert('Faça login primeiro.'); return }
        const url = document.getElementById('sqlUrl').value.trim(); if(!url) return;
        const body = { type:'sql', sqlalchemy_url:url, is_recurring:false };
        const r = await fetch(api('/datasources'), { method:'POST', headers: { 'Content-Type':'application/json', Authorization:`Bearer ${token()}` }, body: JSON.stringify(body)});
        if(r.ok){ closeModal(); loadList(); }
      });

      // Sheets form
      document.getElementById('formSheets').addEventListener('submit', async (e) => {
        e.preventDefault();
        const okTok = await ensureToken(); if(!okTok){ alert('Faça login primeiro.'); return }
        const spreadsheet_id = document.getElementById('sId').value.trim();
        const range = document.getElementById('sRange').value.trim();
        const is_recurring = document.getElementById('sRecurring').checked;
        const body = { type:'google_sheets', config_json:{ spreadsheet_id, range }, is_recurring };
        const r = await fetch(api('/datasources'), { method:'POST', headers: { 'Content-Type':'application/json', Authorization:`Bearer ${token()}` }, body: JSON.stringify(body)});
        if(r.ok){ closeModal(); loadList(); }
      });

      // CSV form
      document.getElementById('formCsv').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('csvMsg');
        msg.textContent = 'Enviando arquivo';
        msg.className = 'text-sm text-slate-500';
        try {
          if(!await ensureToken()){
            msg.textContent = 'Sesso expirada. Faa login novamente.';
            msg.className = 'text-sm text-rose-600';
            return;
          }
          const fileInput = document.getElementById('csvFile');
          const f = fileInput.files[0];
          if(!f){
            msg.textContent = 'Selecione um arquivo CSV ou XLSX.';
            msg.className = 'text-sm text-rose-600';
            return;
          }
          const fd = new FormData(); fd.append('file', f);
          const name = f.name.toLowerCase();
          const endpoint = name.endsWith('.xlsx') ? '/ingest/xlsx' : '/ingest/csv';
          const resp = await fetch(api(endpoint), { method:'POST', headers: { Authorization:`Bearer ${token()}` }, body: fd });
          if(resp.ok){
            try {
              await fetch(api('/datasources'), { method:'POST', headers: { 'Content-Type':'application/json', Authorization:`Bearer ${token()}` }, body: JSON.stringify({ type:'csv_upload', config_json: { filename: f.name, uploaded_at: new Date().toISOString() } })});
            } catch (err) {
              console.error('registrar datasource', err);
            }
            msg.textContent = 'Upload concludo e datasource registrado.';
            msg.className='text-sm text-emerald-600';
            setTimeout(()=>{ closeModal(); loadList(); }, 800);
          } else {
            let txt = '';
            try { txt = await resp.text(); } catch (err) { console.error('resp.text', err); }
            if(txt && txt.length > 600){ txt = txt.slice(0,600) + ''; }
            msg.textContent = 'Falha no upload.' + (txt ? ' ' + txt : '');
            msg.className='text-sm text-rose-600';
          }
        } catch (err) {
          console.error('upload datasource', err);
          msg.textContent = 'Falha no upload. Verifique o arquivo e tente novamente.';
          msg.className='text-sm text-rose-600';
        }
      });

      // Enhance: add delete buttons to each card and wire to DELETE API
      function attachDeleteButtonsWithList(list){
        const c = document.getElementById('dsList');
        if(!c) return;
        const cards = Array.from(c.querySelectorAll('.card'));
        cards.forEach((el, i) => {
          if(el.querySelector('[data-del]')) return;
          const ds = list[i]; if(!ds) return;
          const btn = document.createElement('button');
          btn.className = 'btn text-rose-600 border-rose-200 mt-3';
          btn.textContent = 'Excluir';
          btn.setAttribute('data-del','1');
          btn.addEventListener('click', async () => {
            if(!confirm('Excluir esta fonte de dados?')) return;
            await fetch(api(`/datasources/${ds.id}`), { method:'DELETE', headers:{ Authorization:`Bearer ${token()}` } });
            await loadList();
          });
          el.appendChild(btn);
        });
      }

      const __origLoadList = loadList;
      loadList = async function(){
        await __origLoadList();
        try {
          const r = await fetch(api('/datasources'), { headers: { Authorization: `Bearer ${token()}` } });
          if(r.ok){ const list = await r.json(); attachDeleteButtonsWithList(list); }
        } catch(e) { /* ignore */ }
      }

      showAuthButtons();
      loadList();
    </script>
  </body>
  </html>


